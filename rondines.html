<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Rondines de Vigilancia</title>
<meta name="theme-color" content="#0f172a">
<style>
  :root{
    --bg:#0b1020; --panel:#121a33; --soft:#1b274a; --accent:#3b82f6; --text:#e5e7eb; --muted:#9ca3af; --danger:#ef4444; --ok:#10b981;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,#0a0f1f, #0d1430);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{
    position:sticky;top:0;z-index:5;
    backdrop-filter:saturate(1.2) blur(8px);
    background:rgba(11,16,32,.7); border-bottom:1px solid #1f2a4d;
  }
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:8px 0; display:flex;align-items:center;gap:10px}
  h1 .dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 12px var(--ok)}
  .panel{background:var(--panel);border:1px solid #1e2a52;border-radius:var(--radius);padding:14px}
  .actions{display:flex;flex-wrap:wrap;gap:10px}
  button,.btn{
    appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;color:white;cursor:pointer;
    background:linear-gradient(180deg,#3b82f6,#2563eb); box-shadow:0 6px 16px rgba(37,99,235,.35);
  }
  button.secondary{background:linear-gradient(180deg,#1f2937,#111827);box-shadow:0 6px 16px rgba(0,0,0,.35);color:var(--text)}
  button.danger{background:linear-gradient(180deg,#ef4444,#dc2626)}
  button.ghost{background:transparent;border:1px dashed #3b82f6;color:#93c5fd}
  button:disabled{opacity:.6;cursor:not-allowed}
  input[type="file"]{display:none}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1;min-width:260px}
  .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  .field label{font-size:14px;color:var(--muted)}
  .field input[type="text"], .field textarea, .field input[type="datetime-local"]{
    width:100%;padding:12px 12px;border-radius:12px;border:1px solid #2a3766;background:#0f1733;color:var(--text);
  }
  textarea{min-height:90px;resize:vertical}
  .grid{
    display:grid;gap:12px;
    grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  }
  .card{background:var(--soft);border:1px solid #263361;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .thumb{aspect-ratio:4/3;display:block;background:#0a0f1f;position:relative}
  .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .card .body{padding:10px;display:flex;flex-direction:column;gap:8px}
  .meta{font-size:12px;color:var(--muted)}
  .badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:4px 8px;border-radius:999px;background:#0e1530;border:1px solid #2a3766;color:#c7d2fe}
  .footer{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:8px}
  .small{font-size:12px;color:var(--muted)}
  .spacer{flex:1}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #32406f;background:#101a3b;color:#cbd5e1;font-size:12px}
  .hidden{display:none}
  .hint{font-size:13px;color:#a5b4fc}
  .divider{height:1px;background:#1f2a4d;margin:10px 0}
  .sticky-actions{position:sticky;bottom:0;z-index:4;padding:12px 0;background:linear-gradient(180deg,transparent, rgba(11,16,32,.9) 40%, rgba(11,16,32,.95));}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #253055;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;box-shadow:0 6px 16px rgba(0,0,0,.35);max-width:90vw}
  .toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-4px)}
  .kicker{font-size:12px;letter-spacing:.12em;color:#93c5fd;text-transform:uppercase}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1><span class="dot"></span> Rondines de Vigilancia</h1>
      <div class="small">Toma fotos, agrega comentarios y genera un PDF para compartir por WhatsApp.</div>
    </div>
  </header>

  <main class="wrap" id="app">
    <section class="panel">
      <div class="row">
        <div class="col">
          <div class="field">
            <label class="kicker">Datos del rond√≠n</label>
            <input id="rondaTitulo" type="text" placeholder="Ej. Rond√≠n Nocturno ‚Äì Planta A">
          </div>
          <div class="field">
            <input id="rondaResponsable" type="text" placeholder="Responsable / Guardia">
          </div>
          <div class="field">
            <textarea id="rondaNotas" placeholder="Notas generales del rond√≠n (opcional)"></textarea>
          </div>
          <div class="field">
            <label class="pill"><input type="checkbox" id="gpsChk"> Adjuntar ubicaci√≥n (cuando se genere el PDF)</label>
            <div class="hint">La ubicaci√≥n se solicitar√° al generar el PDF. Se agregar√° al encabezado.</div>
          </div>
        </div>

        <div class="col">
          <div class="field">
            <label class="kicker">Captura</label>
            <div class="actions">
              <label for="cameraInput" class="btn">üì∏ Tomar foto</label>
              <input id="cameraInput" type="file" accept="image/*" capture="environment" multiple>
              <button id="pickFile" class="secondary">üñºÔ∏è Elegir de galer√≠a</button>
              <input id="galleryInput" type="file" accept="image/*" multiple class="hidden">
              <button id="clearAll" class="danger">üßπ Limpiar todo</button>
            </div>
            <div class="divider"></div>
            <div class="small">Consejo: toma una foto por punto de control y escribe el comentario debajo.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" style="margin-top:14px">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="col" style="min-width:auto;flex:0 0 auto">
          <span class="kicker">Evidencias</span>
        </div>
        <div class="col" style="min-width:auto;flex:0 0 auto">
          <span class="pill" id="countPill">0 fotos</span>
        </div>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div class="sticky-actions">
        <div class="actions">
          <button id="genPdf">üßæ Generar PDF</button>
          <button id="sharePdf" class="secondary">üü¢ Compartir por WhatsApp</button>
          <span class="spacer"></span>
          <a id="downloadLink" class="btn ghost" href="#" download="rondin.pdf">‚¨áÔ∏è Descargar PDF</a>
        </div>
        <div class="small">El PDF se genera en tu dispositivo; nada se sube a servidores.</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">Listo</div>

  <!-- jsPDF (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-NA2mL3Y9j8oM1c9yH7xB8XKwWeu1uQ3c9zMscP8t0hJmJmcIFCwQ5sx6Yj3S6o6S7d+9PRxX1c9wB2cI3hC0Vg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
  // ------- Estado -------
  const state = {
    items: [] // { id, blob, dataUrl, caption, ts }
  };

  // ------- Utilidades -------
  const $ = s => document.querySelector(s);
  const grid = $('#grid');
  const countPill = $('#countPill');
  const toast = $('#toast');

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 2000);
  }

  function fmtDate(ts){
    const d = new Date(ts);
    return d.toLocaleString();
  }

  // Comprimir la imagen para PDF (m√°x 1280px ancho/alto)
  async function compressImage(file, maxSize=1280, quality=0.82){
    const img = new Image();
    const dataUrl = await fileToDataURL(file);
    img.src = dataUrl;
    await img.decode();

    const {canvas, ctx} = createCanvasForImage(img, maxSize);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
    const outDataUrl = await fileToDataURL(blob);
    return { blob, dataUrl: outDataUrl };
  }

  function createCanvasForImage(img, maxSize){
    const ratio = img.width / img.height;
    let w = img.width, h = img.height;
    if (w > h && w > maxSize){ h = Math.round(maxSize / ratio); w = maxSize; }
    else if (h >= w && h > maxSize){ w = Math.round(maxSize * ratio); h = maxSize; }
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d', {alpha:false});
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h); // fondo blanco para JPEG
    return {canvas, ctx};
  }

  function fileToDataURL(file){
    return new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  function updateCount(){
    const n = state.items.length;
    countPill.textContent = `${n} foto${n===1?'':'s'}`;
  }

  function render(){
    updateCount();
    grid.innerHTML = '';
    state.items.forEach(it=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="thumb"><img src="${it.dataUrl}" alt="Foto del rond√≠n"></div>
        <div class="body">
          <div class="meta">Tomada: ${fmtDate(it.ts)}</div>
          <textarea class="caption" placeholder="Comentario de esta foto...">${it.caption||''}</textarea>
          <div class="footer">
            <span class="badge">#${it.id.slice(-5)}</span>
            <span class="spacer"></span>
            <button class="danger btn-del">Eliminar</button>
          </div>
        </div>
      `;
      // eventos
      card.querySelector('.caption').addEventListener('input', e=>{
        it.caption = e.target.value;
      });
      card.querySelector('.btn-del').addEventListener('click', ()=>{
        state.items = state.items.filter(x=>x.id!==it.id);
        render();
      });
      grid.appendChild(card);
    });
  }

  function addFiles(files){
    if(!files || !files.length) return;
    const list = Array.from(files);
    (async ()=>{
      for (const f of list){
        try{
          const {blob, dataUrl} = await compressImage(f);
          state.items.push({
            id: crypto.randomUUID(),
            blob, dataUrl, caption:'', ts: Date.now()
          });
        }catch(e){
          console.error(e);
          showToast('No se pudo procesar una imagen');
        }
      }
      render();
      showToast('Im√°genes agregadas');
    })();
  }

  // ------- Captura -------
  const camInput = $('#cameraInput');
  const galInput = $('#galleryInput');
  $('#pickFile').addEventListener('click', ()=> galInput.click());
  camInput.addEventListener('change', e => addFiles(e.target.files));
  galInput.addEventListener('change', e => addFiles(e.target.files));

  // ------- Limpiar -------
  $('#clearAll').addEventListener('click', ()=>{
    if (state.items.length===0) { showToast('No hay fotos'); return; }
    if (confirm('¬øEliminar todas las fotos y comentarios?')){
      state.items = []; render(); showToast('Limpio');
    }
  });

  // ------- Generar PDF -------
  async function getLocationIfNeeded(){
    const want = $('#gpsChk').checked;
    if(!want) return null;
    return new Promise((resolve)=>{
      if(!navigator.geolocation){
        resolve({error:'Sin geolocalizaci√≥n'});
        return;
      }
      const opt = {enableHighAccuracy:false, timeout:8000, maximumAge:60000};
      navigator.geolocation.getCurrentPosition(
        pos => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy}),
        err => resolve({error: err.message}),
        opt
      );
    });
  }

  async function buildPdfBlob(){
    if (state.items.length===0) throw new Error('Agrega al menos una foto');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'pt', format:'a4', compress:true });
    const page = { w: pdf.internal.pageSize.getWidth(), h: pdf.internal.pageSize.getHeight() };

    const title = $('#rondaTitulo').value.trim() || 'Rond√≠n de vigilancia';
    const resp  = $('#rondaResponsable').value.trim() || '';
    const notas = $('#rondaNotas').value.trim() || '';

    const loc = await getLocationIfNeeded();
    const createdAt = new Date();

    // Encabezado
    function header(){
      pdf.setFillColor(15, 23, 42); // barra
      pdf.rect(0,0,page.w,52,'F');
      pdf.setTextColor(255,255,255);
      pdf.setFont('helvetica','bold'); pdf.setFontSize(14);
      pdf.text(title, 28, 32, {maxWidth: page.w-56});
      pdf.setFont('helvetica','normal'); pdf.setFontSize(10);
      let line2 = `Generado: ${createdAt.toLocaleString()}`;
      if (resp) line2 += `  |  Responsable: ${resp}`;
      pdf.text(line2, 28, 48);

      if (loc && !loc.error){
        pdf.setFontSize(9);
        pdf.text(`Ubicaci√≥n: ${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)} (¬±${Math.round(loc.acc)}m)`, page.w-28, 48, {align:'right'});
      }else if(loc && loc.error){
        pdf.setFontSize(9);
        pdf.text(`Ubicaci√≥n: no disponible (${loc.error})`, page.w-28, 48, {align:'right'});
      }

      pdf.setTextColor(20,20,20);
    }

    // Portada con notas
    header();
    pdf.setTextColor(20,20,20);
    pdf.setFont('helvetica','bold'); pdf.setFontSize(16);
    pdf.text('Resumen del rond√≠n', 28, 90);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(12);
    const resumen = notas ? notas : 'Sin notas generales.';
    pdf.text(resumen, 28, 120, {maxWidth: page.w-56});
    pdf.setFontSize(11);
    pdf.text(`Evidencias: ${state.items.length} foto(s)`, 28, 160);

    // Cada foto en su p√°gina
    for (let i=0;i<state.items.length;i++){
      const it = state.items[i];
      if (i>0 || state.items.length>0){ pdf.addPage(); }
      header();

      // √°rea disponible
      const top = 68, margin = 28, captionH = 80, spacing = 10;
      const imgAreaH = page.h - top - captionH - margin - spacing;

      // Cargar imagen
      const img = new Image();
      img.src = it.dataUrl;
      await img.decode();

      // Calcular fit (centrado con marco)
      let w = img.width, h = img.height;
      const rImg = w/h, rPage = (page.w - margin*2) / imgAreaH;
      if (rImg > rPage){ // limita por ancho
        w = page.w - margin*2;
        h = Math.round(w / rImg);
      } else {
        h = imgAreaH;
        w = Math.round(h * rImg);
      }
      const x = Math.round((page.w - w)/2), y = top + Math.round((imgAreaH - h)/2);

      pdf.setDrawColor(220); pdf.setLineWidth(1);
      pdf.rect(x-1, y-1, w+2, h+2); // marco
      pdf.addImage(it.dataUrl, 'JPEG', x, y, w, h);

      // Pie de foto
      pdf.setFont('helvetica','bold'); pdf.setFontSize(12); pdf.setTextColor(30,30,30);
      pdf.text(`Foto ${i+1} de ${state.items.length}`, margin, page.h - margin - captionH + 20);
      pdf.setFont('helvetica','normal'); pdf.setFontSize(11); pdf.setTextColor(60,60,60);
      const cap = (it.caption && it.caption.trim()) ? it.caption.trim() : 'Sin comentario.';
      pdf.text(cap, margin, page.h - margin - captionH + 40, {maxWidth: page.w - margin*2});

      pdf.setFontSize(10);
      pdf.text(`Tomada: ${fmtDate(it.ts)}`, margin, page.h - margin - 16);

      pdf.setTextColor(20,20,20);
    }

    // Salida
    const blob = pdf.output('blob');
    return blob;
  }

  // Bot√≥n Generar PDF (solo genera y actualiza enlace de descarga)
  $('#genPdf').addEventListener('click', async ()=>{
    try{
      const blob = await buildPdfBlob();
      const url = URL.createObjectURL(blob);
      const link = $('#downloadLink');
      link.href = url;
      link.download = makeFileName();
      showToast('PDF generado ‚úÖ (usa Descargar o Compartir)');
    }catch(e){
      alert(e.message || 'Error generando PDF');
    }
  });

  function makeFileName(){
    const title = ($('#rondaTitulo').value.trim() || 'rondin').toLowerCase()
      .replace(/[^a-z0-9√°√©√≠√≥√∫√±√º ]/gi,'').replace(/\s+/g,'-');
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    return `${title}-${stamp}.pdf`;
  }

  // Compartir por WhatsApp (Web Share API con archivo)
  $('#sharePdf').addEventListener('click', async ()=>{
    try{
      const blob = await buildPdfBlob();
      const fileName = makeFileName();
      const file = new File([blob], fileName, {type:'application/pdf'});

      if (navigator.canShare && navigator.canShare({ files: [file] })){
        await navigator.share({
          files: [file],
          title: 'Rond√≠n de vigilancia',
          text: 'Env√≠o PDF del rond√≠n.'
        });
        showToast('Compartido ‚úî');
      } else {
        // Fallback: ofrecer descarga y abrir WhatsApp (sin adjunto autom√°tico)
        const url = URL.createObjectURL(blob);
        const a = $('#downloadLink');
        a.href = url; a.download = fileName;
        showToast('Tu navegador no soporta compartir archivos. Descarga el PDF y adj√∫ntalo en WhatsApp.');
        // Intento de abrir WhatsApp (no adjunta el archivo autom√°ticamente en escritorio)
        window.open('https://wa.me/', '_blank');
      }
    }catch(e){
      alert(e.message || 'Error al compartir PDF');
    }
  });

  // --------- Accesos r√°pidos por teclado (desktop) ---------
  document.addEventListener('keydown', (e)=>{
    if (e.key==='n' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); $('#cameraInput').click(); }
  });

  </script>
</body>
</html>